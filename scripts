"use strict";function getAllAsins(n,e){var t="https://"+e+"/gp/product/"+n;return new Promise(function(e,r){getAjaxResponse(t).then(function(t){var r=[];try{var o=t.match(/asinVariationValues" :(.*)\n/)[1];o=o.substring(0,o.length-1);var s=JSON.parse(o);r=Object.keys(s);var i=t.match(/parentAsin" : "(.*)",\n/)[1];i&&r.push(i)}catch(a){}r.push(n),e(r)})})}function getCompetitionProductAndRankForKeywords(n,e,t,r,o,s){o=o||20;var i=r.map(function(r){return getCompetitionProductAndRank(n,e,t,r,o,s)});return Promise.all(i)}function getCompetitionProductAndRank(n,e,t,r,o,s){return new Promise(function(i,a){getCompetingProduct(t,r).then(function(a){getAllAsins(e[0],t).then(function(e){getRank(e,t,r,o,s).then(function(o){var s=o.rank,c=o.currentPage,u=o.currentRankedAsin,d=null===o.currentIsSponsored?"-":o.currentIsSponsored?"Y":"N";getIndexed(e,t,r).then(function(e){i({indexed:e,competingProduct:a,rank:s,page:c,rankedAsin:u,isSponsored:d,exact:n[r]?n[r].EXACT:null,broad:n[r]?n[r].BROAD:null})})})})})})}function sleep(n){return new Promise(function(e,t){setTimeout(function(){e(1)},1e3*n)})}function getAjaxResponse(n){return new Promise(function(e,t){$.ajax({type:"GET",url:n,success:function(n){e(n)},error:function(){t()}})})}function getSearchVolume(n,e){return new Promise(function(n,e){n({})})}function getIndexed(n,e,t){var r=n[0],o="https://"+e+"/s/?field-keywords="+encodeURIComponent(r)+encodeURIComponent(t);return new Promise(function(n,e){getAjaxResponse(o).then(function(e){var t=0===$($.parseHTML(e)).find("#noResultsTitle").length?"Y":"N";n(t)})})}function getRank(n,e,t,r,o){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;return new Promise(function(a,c){var u="https://"+e+"/s/?field-keywords="+encodeURIComponent(t)+"&page="+s;getAjaxResponse(u).then(function(c){var u=0,d=null,f=null;if(o){var l=$($.parseHTML(c)).find(".s-result-item").get().filter(function(n){return 0===$(n).find(".acs-showcase-result-item-amazons-choice").length&&$(n).attr("data-asin")&&$(n).attr("class").indexOf("acs-private-brands-container-background")===-1});l.forEach(function(e){if(!d){u++;var t=$(e).attr("data-asin");n.includes(t)&&(d=t,f=$(e).find(".s-sponsored-header").length>0||$(e).text().toLowerCase().match(/Sponsored|Gesponsert|Gesponsord|Sponsorowane|Sponsorlu|Sponzorováno|Sponsorisé|Patrocinado|Sponsorizzato|Patrocinado/gi)||$(e).text().toLowerCase().indexOf("商品推广")!==-1||$(e).text().toLowerCase().indexOf("スポンサー プロダクト")!==-1)}})}else{var l=$($.parseHTML(c)).find(".s-result-item").get().filter(function(n){return 0===$(n).find(".acs-showcase-result-item-amazons-choice").length&&$(n).attr("data-asin")&&$(n).attr("class").indexOf("acs-private-brands-container-background")===-1}).map(function(n){return $(n).attr("data-asin")});l.forEach(function(e){u++,n.indexOf(e)!==-1&&(d=e)})}if(d){i+=u;var p="Page "+s+" No "+u;a({rank:i,currentPage:p,currentRankedAsin:d,currentIsSponsored:f})}else if(s===r){var g="Not in first "+r+" pages";a({rank:g,currentPage:g,currentRankedAsin:null,currentIsSponsored:f})}else s++,i+=l.length,a(getRank(n,e,t,r,o,s,i))})})}function getCompetingProduct(n,e){return new Promise(function(t,r){var o="https://"+n+"/s/?field-keywords="+encodeURIComponent(e)+"&page=1";getAjaxResponse(o).then(function(e){var r=$($.parseHTML(e)).find("#s-result-count").length>0?$($.parseHTML(e)).find("#s-result-count"):$($.parseHTML(e)).find(".rush-component .s-desktop-toolbar .sg-row-align-items-center .a-spacing-small SPAN"),o="0";if(r&&r.length>0){var s=r[0].innerText.toLowerCase();if(n.indexOf("jp")===-1){var i=/([\d,.\s]+) (result|résult|risult|ergebnissen|ergebnisse)/i;try{o=i.exec(s.toLowerCase())[1]}catch(a){}}else o=s.indexOf("以上")!==-1?s.substring(s.indexOf("検索結果"),s.indexOf("以上")):s.substring(s.indexOf("検索結果")===-1?parseInt(s)||0:s.indexOf("検索結果"),s.indexOf("のうち"))}o=o.replace(/[^0-9]/g,""),o=parseInt(o)||0,o>0&&o%1e3===0&&(o+="+"),t(o)})})}chrome.action.setBadgeText({text:""}),chrome.action.onClicked.addListener(function(n){chrome.tabs.create({url:"index.html"},function(){})});